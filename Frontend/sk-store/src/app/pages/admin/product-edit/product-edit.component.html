<div class="container mx-auto">
  <h1 class="text-2xl font-bold text-gray-800 mb-6">
    {{ isEditMode() ? 'Chỉnh sửa Sản phẩm' : 'Thêm Sản phẩm mới' }}
  </h1>

  @if (isLoading()) {
    <p>Đang tải dữ liệu...</p>
  } @else {
    <form [formGroup]="productForm" (ngSubmit)="onSubmit()" class="bg-white p-6 rounded-lg shadow-md space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Product Name -->
        <div>
          <label for="productName" class="form-label">Tên sản phẩm</label>
          <input id="productName" type="text" formControlName="productName" class="form-input">
        </div>

        <!-- Price -->
        <div>
          <label for="price" class="form-label">Giá</label>
          <input id="price" type="number" formControlName="price" class="form-input">
        </div>

        <!-- Stock Quantity -->
        <div>
          <label for="stockQuantity" class="form-label">Số lượng tồn kho</label>
          <input id="stockQuantity" type="number" formControlName="stockQuantity" class="form-input">
        </div>

        <!-- Category -->
        <div>
          <label for="categoryId" class="form-label">Danh mục</label>
          <select id="categoryId" formControlName="categoryId" class="form-input">
            @for (category of categories(); track category.categoryId) {
              <option [value]="category.categoryId">{{ category.categoryName }}</option>
            }
          </select>
        </div>

        <!-- Brand -->
        <div>
          <label for="brandId" class="form-label">Thương hiệu</label>
          <select id="brandId" formControlName="brandId" class="form-input">
            @for (brand of brands(); track brand.brandId) {
              <option [value]="brand.brandId">{{ brand.brandName }}</option>
            }
          </select>
        </div>

        <!-- Is Active -->
        <div class="flex items-center">
          <input id="isActive" type="checkbox" formControlName="isActive" class="h-4 w-4 text-primary rounded border-gray-300 focus:ring-primary">
          <label for="isActive" class="ml-2 form-label">Hiển thị sản phẩm</label>
        </div>
      </div>

      <!-- Description -->
      <div>
        <label for="description" class="form-label">Mô tả</label>
        <textarea id="description" formControlName="description" rows="4" class="form-input"></textarea>
      </div>

      <!-- Image Management Section -->
      <div class="space-y-6">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-medium text-gray-800">Quản lý ảnh sản phẩm</h3>
          @if (imageChangesSignal()) {
            <span class="bg-orange-100 text-orange-800 text-sm px-2 py-1 rounded">
              Có thay đổi chưa lưu
            </span>
          }
        </div>
        
        <!-- Primary Image Section -->
        <div class="border rounded-lg p-4">
          <h4 class="text-md font-medium text-gray-700 mb-3">Ảnh chính</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Current Primary Image -->
            <div>
              @if (currentPrimaryImage()) {
                <div class="relative group">
                  <img [src]="getImageUrl(currentPrimaryImage()!.imageUrl)" 
                       [alt]="productForm.get('productName')?.value || 'Product'"
                       class="w-full h-48 object-cover rounded-lg border">
                  <div class="absolute top-2 left-2 bg-blue-500 text-white text-xs px-2 py-1 rounded">
                    Ảnh chính
                  </div>
                  <button type="button" 
                          (click)="deletePrimaryImage()"
                          class="absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white p-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                    <i class="fas fa-trash text-sm"></i>
                  </button>
                </div>
              } @else {
                <div class="border-2 border-dashed border-gray-300 rounded-lg h-48 flex items-center justify-center">
                  <div class="text-center text-gray-500">
                    <i class="fas fa-image text-2xl mb-2"></i>
                    <p>Chưa có ảnh chính</p>
                  </div>
                </div>
              }
            </div>
            
            <!-- Primary Image Upload -->
            <div>
              <div class="border-2 border-dashed border-gray-300 rounded-lg h-48 flex items-center justify-center cursor-pointer hover:border-gray-400 transition-colors"
                   (click)="primaryImageInput.click()">
                <div class="text-center text-gray-500">
                  <i class="fas fa-cloud-upload-alt text-2xl mb-2"></i>
                  <p>{{ currentPrimaryImage() ? 'Thay đổi ảnh chính' : 'Upload ảnh chính' }}</p>
                  <p class="text-xs mt-1">JPG, PNG • Max 5MB</p>
                </div>
              </div>
              <input #primaryImageInput
                     type="file"
                     accept="image/*,.jpg,.jpeg,.png"
                     (change)="onPrimaryImageSelect($event)"
                     class="hidden">
            </div>
          </div>
        </div>

        <!-- Secondary Images Section -->
        <div class="border rounded-lg p-4">
          <h4 class="text-md font-medium text-gray-700 mb-3">Ảnh phụ (tối đa 4 ảnh)</h4>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            @for (item of secondaryImageSlots(); track $index) {
              <div class="relative group">
                @if (item.image) {
                  <!-- Existing Secondary Image -->
                  <img [src]="getImageUrl(item.image.imageUrl)" 
                       [alt]="productForm.get('productName')?.value || 'Product'"
                       class="w-full h-32 object-cover rounded-lg border">
                  <button type="button" 
                          (click)="deleteSecondaryImage($index)"
                          class="absolute top-1 right-1 bg-red-500 hover:bg-red-600 text-white p-1 rounded text-xs opacity-0 group-hover:opacity-100 transition-opacity">
                    <i class="fas fa-trash"></i>
                  </button>
                } @else {
                  <!-- Empty Slot -->
                  <div class="border-2 border-dashed border-gray-300 rounded-lg h-32 flex items-center justify-center cursor-pointer hover:border-gray-400 transition-colors"
                       (click)="triggerSecondaryInput($index)">
                    <div class="text-center text-gray-500">
                      <i class="fas fa-plus text-lg mb-1"></i>
                      <p class="text-xs">Thêm ảnh</p>
                    </div>
                  </div>
                }
                <input [id]="'secondaryInput' + $index"
                       type="file"
                       accept="image/*,.jpg,.jpeg,.png"
                       (change)="onSecondaryImageSelect($event, $index)"
                       class="hidden">
              </div>
            }
          </div>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="flex justify-end gap-4 pt-4">
        <button type="button" (click)="goBack()" class="btn-secondary">Hủy</button>
        <button type="submit" [disabled]="productForm.invalid || isLoading()" class="btn-primary">
          @if(isLoading()) {
            <span>Đang lưu...</span>
          } @else {
            <span>Lưu sản phẩm</span>
          }
        </button>
      </div>
    </form>
  }
</div>